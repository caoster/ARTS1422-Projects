<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="description" content="ARTS1422 Group 7">
    <title>Group 7</title>
    <style>
        body {
            margin: 0;
            font: 13px/1.5 "Microsoft YaHei", "Helvetica Neue", "Sans-Serif";
            width: 100%;
            height: 100vh;
        }

        .my-map {
            margin: 0 auto;
            width: 100%;
            height: 90vh;
        }

        .amap-container {
            height: 100%;
        }

        .myinfowindow {
            width: 240px;
            min-height: 50px;
        }

        .myinfowindow h5 {
            height: 20px;
            line-height: 20px;
            overflow: hidden;
            font-size: 14px;
            font-weight: bold;
            width: 220px;
            text-overflow: ellipsis;
            word-break: break-all;
            white-space: nowrap;
        }

        .myinfowindow div {
            margin-top: 10px;
            min-height: 40px;
            line-height: 20px;
            font-size: 13px;
            color: #6f6f6f;
        }

        div.left-panel {
            position: absolute;
            top: 10%;
            left: 5%;
            width: 243px;
            height: 487px;
            /*border: 3px solid #73AD21;*/
        }
    </style>
</head>
<body>
<div id="wrap" class="my-map">
    <div id="mapContainer" class="amap-container"></div>
    <div id="left-panel" class="left-panel"></div>
</div>

<script type="text/javascript">
    window._AMapSecurityConfig = {
        serviceHost: '/_AMapService'
    }
</script>
<script src="static/panel.js"></script>
<script src="static/iconGen.js"></script>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="//webapi.amap.com/maps?v=1.4.15&key=c47c57fecbe4f750cdb90854f1c9a814"></script>
<script src="//webapi.amap.com/loca?v=1.3.2&key=c47c57fecbe4f750cdb90854f1c9a814"></script>
<script src="//a.amap.com/Loca/static/dist/jquery.min.js"></script>
<script>
    function genMarker(data) {
        let feature;
        switch (data.type) {
            case "Station": {
                feature = new AMap.Marker({
                    position: new AMap.LngLat(data.lnglat.lng, data.lnglat.lat), zIndex: 3, title: data.name,
                    content: fire_station_icon(data.level), offset: new AMap.Pixel(data.offset.x, data.offset.y),
                    extData: data

                });
                AMap.event.addListener(feature, "click", mapFeatureClick);
                break;
            }
            case "Fire": {
                feature = new AMap.Marker({
                    position: new AMap.LngLat(data.lnglat.lng, data.lnglat.lat), zIndex: 3, title: data.name,
                    content: fire_icon(data.level), offset: new AMap.Pixel(data.offset.x, data.offset.y),
                    extData: data
                });
                AMap.event.addListener(feature, "click", mapFeatureClick);
                break;
            }
            case "Population": {
                let path = [
                    new AMap.LngLat(data.lnglat.lng, data.lnglat.lat),
                    new AMap.LngLat(data.lnglat.lng, data.lnglat.lat + 0.027),
                    new AMap.LngLat(data.lnglat.lng + 0.027, data.lnglat.lat + 0.027),
                    new AMap.LngLat(data.lnglat.lng + 0.027, data.lnglat.lat)
                ]
                feature = new AMap.Polygon({
                    map: map, path: path, extData: data, zIndex: 1,
                    fillColor: `rgba(227, 209, 110, ${opacity_population(data.population)})`,
                    strokeOpacity: 0
                });
                break;
            }
            case "Enterprise": {
                let path = [
                    new AMap.LngLat(data.lnglat.lng, data.lnglat.lat),
                    new AMap.LngLat(data.lnglat.lng, data.lnglat.lat + 0.027),
                    new AMap.LngLat(data.lnglat.lng + 0.027, data.lnglat.lat + 0.027),
                    new AMap.LngLat(data.lnglat.lng + 0.027, data.lnglat.lat)
                ]
                feature = new AMap.Polygon({
                    map: map, path: path, extData: data, zIndex: 1,
                    fillColor: `rgba(136, 91, 193, ${opacity_enterprise(data.capital, data.count)})`,
                    strokeOpacity: 0
                });
                break;
            }
        }
        return feature;
    }

    let infoWindow, map, level = 13,
        center = {lng: 120.14325, lat: 30.281472}; // amap location

    function mapFeatureClick(e) {
        if (!infoWindow) {
            infoWindow = new AMap.InfoWindow({autoMove: true, isCustom: false});
        }
        let extData = e.target.getExtData();
        infoWindow.setContent("<div class='myinfowindow'><h5>" + extData.name + "</h5><div>" + extData.desc + "</div></div>");
        infoWindow.open(map, e.lnglat);
    }

    map = new AMap.Map("mapContainer",
        {
            mapStyle: "amap://styles/7ee3a74e7122d6cff8845b7085c0b971",
            center: new AMap.LngLat(center.lng, center.lat),
            level: level,
            keyboardEnable: true,
            dragEnable: true,
            scrollWheel: true,
            doubleClickZoom: true,
            // viewMode: '3D',
        });
    new AMap.TileLayer.RoadNet({map: map, zIndex: 2});

    map.on('complete', function () {
        map.plugin(["AMap.OverView", "AMap.Scale"], function () {
            map.addControl(new AMap.OverView({isOpen: true}));
            map.addControl(new AMap.Scale);
        });
        console.log("Complete!");
    });

</script>
<script>
    /* Helper function */
    function isEarlierEqual(a, b) {
        if (a.year < b.year) return true;
        if (a.year > b.year) return false;
        // Same year
        return a.month <= b.month;
    }

    function loadScript(src, callback) {
        let script = document.createElement('script');
        script.setAttribute('src', src);
        script.addEventListener('load', callback, {once: true})
        document.head.appendChild(script);
    }

    let begin = new Date();
    begin.setFullYear(2020);
    begin.setMonth(7);
    let end = new Date();
    end.setFullYear(2021);
    end.setMonth(1);

    function inTimePeriod(obj) {
        return begin <= obj.time && obj.time <= end;
    }

    function beforeEndTime(obj) {
        return obj.time <= end;
    }


</script>

<script>
    let population_industry = []
    d3.text("/data/population_industry.csv", function (text) {
        population_industry = d3.csvParseRows(text, d => d.map(Number));
        // display_population({"year": 2020, "month": 7}, {"year": 9999, "month": 1});
        // display_enterprise({"year": 2020, "month": 7}, {"year": 9999, "month": 1});
    });


    let marker_population = new AMap.OverlayGroup([]);

    function display_population(from, to) {
        marker_population.clearOverlays();
        let begin_column = Math.max((from.year - 2007) * 12 + from.month - 1, 0);
        let end_column = Math.min((to.year - 2007) * 12 + to.month - 1, (population_industry[0].length - 2) / 3 - 1);

        for (const locationElement of population_industry) {
            let i = begin_column, avg = 0;
            while (i <= end_column) {
                avg += locationElement[3 * i + 2];
                i++;
            }
            avg /= (end_column - begin_column);
            marker_population.addOverlay(genMarker({
                "type": "Population",
                "lnglat": {"lng": locationElement[1], "lat": locationElement[0]}, "population": avg
            }));
        }
        map.add(marker_population)
    }

    let marker_enterprise = new AMap.OverlayGroup([]);

    function display_enterprise(from, to) {
        marker_enterprise.clearOverlays();
        let begin_column = Math.max((from.year - 2007) * 12 + from.month - 1, 0);
        let end_column = Math.min((to.year - 2007) * 12 + to.month - 1, (population_industry[0].length - 2) / 3 - 1);

        for (const locationElement of population_industry) {
            let i = begin_column, avg_capital = 0, avg_count = 0;
            while (i <= end_column) {
                avg_capital += locationElement[3 * i + 3];
                avg_count += locationElement[3 * i + 4];
                i++;
            }
            avg_capital /= (end_column - begin_column);
            avg_count /= (end_column - begin_column);

            marker_enterprise.addOverlay(genMarker({
                "type": "Enterprise",
                "lnglat": {"lng": locationElement[1], "lat": locationElement[0]},
                "capital": avg_capital, "count": avg_count
            }));
        }
        map.add(marker_enterprise)
    }
</script>
<script>
    loadScript("/data/fire.js", function () {
        for (let fireElement of fire) {
            fireElement.time = new Date(fireElement.time)
        }
        console.log("Fire data loaded!");
        display_fire(inTimePeriod);
    })

    let fireLayer = new Loca.ScatterPointLayer({
        map: map,
        eventSupport: true,
        zIndex: 300
    });

    /* filter is a function that returns bool */
    function display_fire(filter) {
        let display_fire_list = [];
        for (const fireElement of fire) {
            if (filter(fireElement)) {
                display_fire_list.push(fireElement);
            }
        }
        fireLayer.setData(display_fire_list, {lnglat: 'lnglat'});
        fireLayer.setOptions({
            unit: 'px',
            style: {
                radius: function (obj) {
                    return radius_fire(obj.value.level);
                },
                color: 'rgb(251, 61, 95)',
            }
        });
        fireLayer.render();
    }
</script>
<script>
    loadScript("/data/fire_station.js", function () {
        for (let fireStationElement of fire_station) {
            fireStationElement.time = new Date(fireStationElement.time)
        }
        console.log("Fire station data loaded!");
        display_fire_station(beforeEndTime);
    })

    let fireStationLayer = new Loca.ScatterPointLayer({
        map: map,
        eventSupport: true,
        zIndex: 301
    });

    /* filter is a function that returns bool */
    function display_fire_station(filter) {
        let display_fire_station_list = [];
        for (const fireStationElement of fire_station) {
            if (filter(fireStationElement)) {
                display_fire_station_list.push(fireStationElement);
            }
        }
        fireStationLayer.setData(display_fire_station_list, {lnglat: 'lnglat'});
        fireStationLayer.setOptions({
            unit: 'px',
            style: {
                radius: function (obj) {
                    return radius_fire_station(obj.value.level);
                },
                color: 'rgb(27, 169, 101)',
            }
        });
        fireStationLayer.render();
    }
</script>

</body>
</html>